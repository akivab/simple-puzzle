function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function createDiv(e){var t=document.createElement("div");t.id=guid();if(e){document.body.appendChild(t)}return t}function createPuzzle(e){var t=e.imgSrc;if(!t){throw"Must create puzzle with an image src."}var n=e.callback||function(){alert("You won!")};var r=e.divId||createDiv(true).id;var i=e.rows||3;var s=e.cols||3;var o=e.scale||1;var u=new Image;u.onload=function(){document.body.appendChild(this);var u=e.width;var a=e.height;if(!u&&!a){u=this.clientWidth||300;a=this.clientHeight||300}else if(u){a=u*this.clientHeight/this.clientWidth}else if(a){u=a*this.clientWidth/this.clientHeight}u*=o;a*=o;var f=new Puzzle(r,t,u,a,i,s,n);var l=$(r);while(l.firstChild)l.removeChild(l.firstChild);f.createPieces();document.body.removeChild(this)};u.src=t}function Puzzle(e,t,n,r,i,s,o){this.divId=e;this.imgSrc=t;this.width=n;this.height=r;this.rows=i;this.cols=s;this.callback=o;this.pieces=[];this.original=[];this.fixWidth();this.addListeners()}var $=$||function(e){return document.getElementById(e)};Puzzle.prototype.addListeners=function(){var e=$(this.divId);e.onmousemove=this.onmousemove();e.onmousedown=this.onmousedown();e.onmouseup=this.onmouseup()};Puzzle.prototype.removeListeners=function(){var e=$(this.divId);e.onmousemove=e.onmousedown=e.onmouseup=null};Puzzle.prototype.fixWidth=function(){var e=$(this.divId);e.style.width=this.width+"px";e.style.height=this.height+"px";this.offsetLeft=e.offsetLeft;this.offsetTop=e.offsetTop};Puzzle.prototype.createPieces=function(){var e;for(e=0;e<this.rows*this.cols;++e){this.createPiece(e)}for(e=0;e<this.rows*this.cols;++e){this.original.push(this.pieces[e])}this.mixUp();this.setLocations()};Puzzle.prototype.mixUp=function(){var e=[];while(this.pieces.length){var t=Math.floor(Math.random()*this.pieces.length);e.push(this.pieces.splice(t,1)[0])}this.pieces=e};Puzzle.prototype.setLocations=function(){for(var e=0;e<this.pieces.length;++e){var t=this.pieces[e];var n=this.getPieceDimension(e);t.style.position="absolute";t.style.left=n.left;t.style.top=n.top}};Puzzle.prototype.getPieceDimension=function(e){var t=this.width/this.cols;var n=this.height/this.rows;var r=Math.floor(e/this.cols);var i=e%this.cols;var s=i*t;var o=r*n;return{left:s,top:o,width:t,height:n}};Puzzle.prototype.createPiece=function(e){var t=this.getPieceDimension(e);var n=createDiv(false);var r=$(this.divId);r.appendChild(n);r.style.position="relative";n.style.backgroundSize=this.width+"px "+this.height+"px";n.style.backgroundImage="url("+this.imgSrc+")";n.style.backgroundPosition=this.width-t.left+" "+(this.height-t.top);n.style.width=t.width;n.style.height=t.height;n.style.float="left";n.style.transitionDuration="0.2s";n.num=e;this.pieces.push(n)};Puzzle.prototype.reset=function(){this.col=this.row=this.orig=this.origHover=this.selected=this.hovering=this.selectedIdx=this.hoveringIdx=undefined};Puzzle.prototype.isDone=function(){for(var e=0;e<this.pieces.length;++e){if(e!=this.pieces[e].num){return false}}return true};Puzzle.prototype.onmousemove=function(){var e=this;return function(t){var n=t.clientX-e.offsetLeft;var r=t.clientY-e.offsetTop;e.col=Math.floor(n/e.width*e.cols);e.row=Math.floor(r/e.height*e.rows);e.hoveringIdx=e.row*e.cols+e.col;if(e.selected){var i=e.pieces[e.hoveringIdx];if(i&&i!=e.hovering&&i!=e.selected){if(e.hovering){e.hovering.style.left=e.origHover.left;e.hovering.style.top=e.origHover.top}e.hovering=i;e.origHover={left:i.style.left,top:i.style.top}}if(e.hovering){e.hovering.style.left=e.orig.left;e.hovering.style.top=e.orig.top}e.selected.style.left=t.clientX-e.orig.x;e.selected.style.top=t.clientY-e.orig.y}else{for(var s=0;s<e.pieces.length;++s){e.pieces[s].style.opacity=1}var i=e.pieces[e.hoveringIdx];i.style.opacity=.8}}};Puzzle.prototype.onmousedown=function(){var e=this;return function(t){e.selectedIdx=e.row*e.cols+e.col;e.selected=e.pieces[e.selectedIdx];for(var n=0;n<e.pieces.length;++n){e.pieces[n].style.opacity=.3}if(!e.selected){return}e.selected.style.opacity=1;e.selected.style.transitionDuration="0s";e.orig={x:t.clientX-parseInt(e.selected.style.left,10),y:t.clientY-parseInt(e.selected.style.top,10),left:e.selected.style.left,top:e.selected.style.top}}};Puzzle.prototype.onmouseup=function(){var e=this;return function(t){for(var n=0;n<e.pieces.length;++n){e.pieces[n].style.opacity=1}var r=e.selected;if(e.hovering&&e.selected){e.pieces[e.selectedIdx]=e.hovering;e.pieces[e.hoveringIdx]=e.selected}e.setLocations();e.reset();if(e.isDone()){e.callback();e.removeListeners()}}}